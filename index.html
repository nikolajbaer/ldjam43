<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>LDJ 43</title>
  <style>
    body { padding: 0px; width: 100%; height: 100%; margin: 0px; }
    #cr-stage { width: 100%; height: 100%; background-color: #eee; margin: 2px;}
  </style>
<body>

<div id="cr-stage"></div>

<script src="crafty-min.js"></script>
<script>

var assetsObj = {
    "sprites": {
        "sheep.png": {
            tile: 73,
            tileh: 50,
            map: {
                sheep: [0,0]
            } 
        },
        "bush.png": {
            tile: 150,
            tileh: 70,
            map: {
                bush: [0,0]
            }
        },
        "wolf.png": {
            tile: 100,
            tileh: 100,
            map: {
                wolf: [0,0]
            }
        }
    }
}

function run(){
    var W = Crafty.stage.elem.clientWidth;
    var H = Crafty.stage.elem.clientHeight;
   
    Crafty.createLayer("SheepCanvas","Canvas",{z:1000});
    Crafty.createLayer("BushCanvas","Canvas",{z:200});
    Crafty.createLayer("WolfCanvas","Canvas",{z:100});
 
    var sheep = Crafty.c("Sheep",{
        required: "2D, SheepCanvas, sheep, Gravity, Collide",
        events: {
            "LandedOnGround": function(){
                if(this.dead){ this.vx = 0; return; }
                this.vy = (-Math.random()*100 - 100) * (Math.abs(this.fear) + 0.5);
                this.vx = Math.random() * 100;
                if(this.fear > 0 ){
                    this.vx *= this.fear + 0.5;
                }else if(this.fear < 0){
                    this.vx *= this.fear - 0.5;
                }else{
                    this.vx = 50 - this.vx;
                }
            },
            "UpdateFrame": function(e){
                if(this.x > W - 50 && this.vx > 0){ this.vx *= -1 }
                else if(this.x < 50 && this.vx < 0){ this.vx *= -1 }

                if(this.vx < 0){ this.flip("X")
                }else{ this.unflip("X") }       
                if(this.dead){ this.flip("Y"); } 

                // Subside Fear
                if(this.fear > 0){
                    this.fear -= 0.25 * (e.dt/1000); // fear subsides
                }else if(this.fear < 0){
                    this.fear += 0.25 * (e.dt/1000); // fear subsides
                }
                if( Math.abs(this.fear) < 0.05){ this.fear = 0; }
            }
        },
        fear: function(x){
            var d = this.x - x 
            if(Math.abs(d) < 300){
                this.fear = d / 300;
            } 
        },
        init: function(){
            this.gravity("platform");
            this.w = 73;
            this.h = 50;  
            this.fear = 0; // bias on vx in hop 
            this.dead = false;
        }
    });
   
    // Build Floor 
    var floor = Crafty.e("2D, SheepCanvas, Color, platform, Mouse")
        .color("green")
        .attr({x:0, y:H-5,w:W,h:5});
    // And bushes
    for(var i=0; i<(W/100); i++){
        Crafty.e("bush, 2D, BushCanvas")
            .attr({x:i*100+(5-Math.random()*10),y:H-70,w:125,h:70});
    }

    // TODO make bush and wolf into components   
    var wolf = Crafty.e("2D, wolf, WolfCanvas, Tween, Delay")
        .attr({x: W/2, y: H})
        .delay(function(){
            var b = Crafty("bush").get( Math.floor(Math.random() * Crafty("bush").length))
            // TODO wiggle bus then tween
            this.x = b.x;
            this.y = H; 
            this.tween({y:H-140},500);

            this.delay(function(){
              // Eat Sheep
              var closest = null;
              var d = W;
              var wolfx = this.x;
              Crafty("Sheep").each(function(){
                if( Math.abs(wolfx - this.x ) < d ){
                    closest = this;
                    d = Math.abs(wolfx - this.x);
                } 
              })
              if(d < 50){
                closest.flip("Y");
                closest.dead = true;
                closest.canLand = false;
                closest.vx = 0;
                closest.vy = -200;
                Crafty.s("SheepCanvas").detach(closest); 
                Crafty.s("WolfCanvas").attach(closest);   
              }
              // end eat
              this.tween({y:H},500);
            },1500);
        },7000,-1);

    for(var i=0; i<10; i++){
        var s = Crafty.e("Sheep")
            .attr({
                vx: 50-Math.random()*100,
                vy: -50*Math.random()-50,
                x: W/2 + (50-Math.random()*100),
                y: 100 + 100*Math.random()
            });
    }
    
    Crafty.s("Mouse").bind("Click", function(e){
        console.log(e);
        Crafty("Sheep").each(function(){
            var d = this.x - e.clientX;
            console.log(d);
            if( Math.abs(d) < 300){
                this.fear = (300 - Math.abs(d)) / 300 * Math.sign(d);
            }
        });
    });
}

window.onload = function() {
    Crafty.init();
    Crafty.load(assetsObj, run)
    
};

</script>
</body>
</html>
