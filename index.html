<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>LDJ 43</title>
  <style>
    body { padding: 0px; width: 100%; height: 100%; margin: 0px; }
    #cr-stage { width: 100%; height: 100%; background-color: #eee; margin: 2px;}
  </style>
<body>

<div id="cr-stage"></div>

<script src="crafty-min.js"></script>
<script>

var assetsObj = {
    "sprites": {
        "sheep.png": {
            tile: 73,
            tileh: 50,
            map: {
                sheep: [0,0]
            } 
        }
    }
}

function run(){
    var W = Crafty.stage.elem.clientWidth;
    var H = Crafty.stage.elem.clientHeight;
    
    var sheep = Crafty.c("Sheep",{
        required: "2D, Canvas, sheep, Gravity, Collide",
        events: {
            "LandedOnGround": function(){
                this.vy = (-Math.random()*100 - 100) * (Math.abs(this.fear) + 0.5);
                this.vx = Math.random() * 100;
                if(this.fear > 0 ){
                    this.vx *= this.fear + 0.5;
                }else if(this.fear < 0){
                    this.vx *= this.fear - 0.5;
                }else{
                    this.vx = 50 - this.vx;
                }
            },
            "UpdateFrame": function(e){
                if(this.x > W - 50 && this.vx > 0){ this.vx *= -1 }
                else if(this.x < 50 && this.vx < 0){ this.vx *= -1 }

                if(this.vx < 0){ this.flip("X")
                }else{ this.unflip("X") }       
 
                // Subside Fear
                if(this.fear > 0){
                    this.fear -= 0.25 * (e.dt/1000); // fear subsides
                }else if(this.fear < 0){
                    this.fear += 0.25 * (e.dt/1000); // fear subsides
                }
                if( Math.abs(this.fear) < 0.05){ this.fear = 0; }
            }
        },
        fear: function(x){
            var d = this.x - x 
            if(Math.abs(d) < 300){
                this.fear = d / 300;
            } 
        },
        init: function(){
            this.gravity("platform");
            this.w = 73;
            this.h = 50;  
            this.fear = 0; // bias on vx in hop 
        }
    });
    
    var floor = Crafty.e("2D, Canvas, Color, platform,Mouse")
        .color("green")
        .attr({x:0, y:H-5,w:W,h:5});
    
    for(var i=0; i<10; i++){
        var s = Crafty.e("Sheep")
            .attr({
                vx: 50-Math.random()*100,
                vy: -50*Math.random()-50,
                x: W/2 + (50-Math.random()*100),
                y: 100 + 100*Math.random()
            });
    }
    
    Crafty.s("Mouse").bind("Click", function(e){
        console.log(e);
        Crafty("Sheep").each(function(){
            var d = this.x - e.clientX;
            console.log(d);
            if( Math.abs(d) < 300){
                this.fear = (300 - Math.abs(d)) / 300 * Math.sign(d);
            }
        });
    });
}

window.onload = function() {
    Crafty.init();
    Crafty.load(assetsObj, run)
    
};

</script>
</body>
</html>
